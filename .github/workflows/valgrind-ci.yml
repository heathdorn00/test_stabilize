# Valgrind Memory Analysis CI
# Task 2d1415: Prepare for Week 2 Integration Phase
# Task 541701: Configure Valgrind Failure Condition
#
# Purpose: Run Valgrind memcheck on Linux to detect memory leaks
# Note: Valgrind not available on macOS, must run on Linux runners
#
# Failure Conditions:
#   - Any definite memory leaks (Leak_DefinitelyLost)
#   - Any invalid memory access errors (InvalidRead, InvalidWrite)
#   - Any use-after-free errors (InvalidFree)
#   - Any uninitialized value errors (UninitCondition, UninitValue)
#   - Error count exceeds configurable threshold
#
# @owner @test_stabilize
# @date 2025-11-26

name: Valgrind Memory Analysis

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_pattern:
        description: 'Test pattern to run (e.g., security, integration)'
        required: false
        default: 'security'
      fail_on_leaks:
        description: 'Fail build on any definite memory leaks'
        required: false
        default: 'true'
        type: boolean
      leak_threshold:
        description: 'Maximum allowed definite leaks before failure (0 = zero tolerance)'
        required: false
        default: '0'
      error_threshold:
        description: 'Maximum allowed errors before failure (0 = zero tolerance)'
        required: false
        default: '0'

env:
  # Configurable thresholds (can be overridden via workflow_dispatch)
  LEAK_THRESHOLD: ${{ github.event.inputs.leak_threshold || '0' }}
  ERROR_THRESHOLD: ${{ github.event.inputs.error_threshold || '0' }}
  FAIL_ON_LEAKS: ${{ github.event.inputs.fail_on_leaks || 'true' }}

jobs:
  valgrind-memcheck:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      definite_leaks: ${{ steps.analyze.outputs.definite_leaks }}
      total_errors: ${{ steps.analyze.outputs.total_errors }}
      has_critical_errors: ${{ steps.analyze.outputs.has_critical_errors }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Valgrind
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind

      - name: Verify Valgrind installation
        run: valgrind --version

      - name: Create reports directory
        run: mkdir -p valgrind-reports

      - name: Run Valgrind Memcheck
        id: valgrind
        run: |
          TEST_PATTERN="${{ github.event.inputs.test_pattern || 'security' }}"
          echo "Running memcheck on test pattern: $TEST_PATTERN"

          # Run Valgrind with error-exitcode to capture errors
          # Exit code 1-125 indicates Valgrind detected errors
          valgrind \
            --tool=memcheck \
            --leak-check=full \
            --show-leak-kinds=definite,indirect,possible,reachable \
            --track-origins=yes \
            --track-fds=yes \
            --suppressions=.valgrind/memcheck.supp \
            --xml=yes \
            --xml-file=valgrind-reports/memcheck.xml \
            --log-file=valgrind-reports/memcheck.log \
            --error-exitcode=42 \
            --gen-suppressions=all \
            npm test -- --testPathPattern="$TEST_PATTERN" --runInBand 2>&1 || VALGRIND_EXIT=$?

          echo "valgrind_exit_code=${VALGRIND_EXIT:-0}" >> $GITHUB_OUTPUT

          # Don't fail here - analyze results first
          exit 0

      - name: Analyze Valgrind Results
        id: analyze
        run: |
          echo "## Valgrind Memcheck Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Initialize counters
          DEFINITE_LEAKS=0
          INDIRECT_LEAKS=0
          POSSIBLE_LEAKS=0
          REACHABLE_LEAKS=0
          INVALID_READ=0
          INVALID_WRITE=0
          INVALID_FREE=0
          UNINIT_COND=0
          UNINIT_VALUE=0
          OVERLAP=0
          SYSCALL_PARAM=0
          TOTAL_ERRORS=0
          HAS_CRITICAL=false

          if [ -f valgrind-reports/memcheck.xml ]; then
            # Count leak types
            DEFINITE_LEAKS=$(grep -c 'kind="Leak_DefinitelyLost"' valgrind-reports/memcheck.xml 2>/dev/null || echo "0")
            INDIRECT_LEAKS=$(grep -c 'kind="Leak_IndirectlyLost"' valgrind-reports/memcheck.xml 2>/dev/null || echo "0")
            POSSIBLE_LEAKS=$(grep -c 'kind="Leak_PossiblyLost"' valgrind-reports/memcheck.xml 2>/dev/null || echo "0")
            REACHABLE_LEAKS=$(grep -c 'kind="Leak_StillReachable"' valgrind-reports/memcheck.xml 2>/dev/null || echo "0")

            # Count memory errors (critical)
            INVALID_READ=$(grep -c 'kind="InvalidRead"' valgrind-reports/memcheck.xml 2>/dev/null || echo "0")
            INVALID_WRITE=$(grep -c 'kind="InvalidWrite"' valgrind-reports/memcheck.xml 2>/dev/null || echo "0")
            INVALID_FREE=$(grep -c 'kind="InvalidFree"' valgrind-reports/memcheck.xml 2>/dev/null || echo "0")
            UNINIT_COND=$(grep -c 'kind="UninitCondition"' valgrind-reports/memcheck.xml 2>/dev/null || echo "0")
            UNINIT_VALUE=$(grep -c 'kind="UninitValue"' valgrind-reports/memcheck.xml 2>/dev/null || echo "0")
            OVERLAP=$(grep -c 'kind="Overlap"' valgrind-reports/memcheck.xml 2>/dev/null || echo "0")
            SYSCALL_PARAM=$(grep -c 'kind="SyscallParam"' valgrind-reports/memcheck.xml 2>/dev/null || echo "0")

            # Calculate totals
            TOTAL_ERRORS=$((INVALID_READ + INVALID_WRITE + INVALID_FREE + UNINIT_COND + UNINIT_VALUE + OVERLAP + SYSCALL_PARAM))

            # Check for critical errors (always fail on these)
            if [ "$INVALID_READ" -gt "0" ] || [ "$INVALID_WRITE" -gt "0" ] || [ "$INVALID_FREE" -gt "0" ]; then
              HAS_CRITICAL=true
            fi

            # Memory Leaks Table
            echo "### Memory Leaks" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Leak Type | Count | Severity |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Definitely Lost | $DEFINITE_LEAKS | ðŸ”´ Critical |" >> $GITHUB_STEP_SUMMARY
            echo "| Indirectly Lost | $INDIRECT_LEAKS | ðŸŸ  High |" >> $GITHUB_STEP_SUMMARY
            echo "| Possibly Lost | $POSSIBLE_LEAKS | ðŸŸ¡ Medium |" >> $GITHUB_STEP_SUMMARY
            echo "| Still Reachable | $REACHABLE_LEAKS | ðŸŸ¢ Low |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Memory Errors Table
            echo "### Memory Errors" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Error Type | Count | Severity |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|-------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Invalid Read | $INVALID_READ | ðŸ”´ Critical |" >> $GITHUB_STEP_SUMMARY
            echo "| Invalid Write | $INVALID_WRITE | ðŸ”´ Critical |" >> $GITHUB_STEP_SUMMARY
            echo "| Invalid Free | $INVALID_FREE | ðŸ”´ Critical |" >> $GITHUB_STEP_SUMMARY
            echo "| Uninitialized Condition | $UNINIT_COND | ðŸŸ  High |" >> $GITHUB_STEP_SUMMARY
            echo "| Uninitialized Value | $UNINIT_VALUE | ðŸŸ  High |" >> $GITHUB_STEP_SUMMARY
            echo "| Memory Overlap | $OVERLAP | ðŸŸ  High |" >> $GITHUB_STEP_SUMMARY
            echo "| Syscall Parameter | $SYSCALL_PARAM | ðŸŸ¡ Medium |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Summary
            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Memory Errors:** $TOTAL_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Definite Leaks:** $DEFINITE_LEAKS" >> $GITHUB_STEP_SUMMARY
            echo "- **Leak Threshold:** ${{ env.LEAK_THRESHOLD }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Error Threshold:** ${{ env.ERROR_THRESHOLD }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

          else
            echo "âš ï¸ No Valgrind XML report generated" >> $GITHUB_STEP_SUMMARY
          fi

          # Set outputs for downstream jobs
          echo "definite_leaks=$DEFINITE_LEAKS" >> $GITHUB_OUTPUT
          echo "indirect_leaks=$INDIRECT_LEAKS" >> $GITHUB_OUTPUT
          echo "total_errors=$TOTAL_ERRORS" >> $GITHUB_OUTPUT
          echo "has_critical_errors=$HAS_CRITICAL" >> $GITHUB_OUTPUT
          echo "invalid_read=$INVALID_READ" >> $GITHUB_OUTPUT
          echo "invalid_write=$INVALID_WRITE" >> $GITHUB_OUTPUT
          echo "invalid_free=$INVALID_FREE" >> $GITHUB_OUTPUT

      - name: Upload Valgrind Reports
        uses: actions/upload-artifact@v4
        with:
          name: valgrind-reports
          path: valgrind-reports/
          retention-days: 30

      - name: Check Failure Conditions
        id: check_failure
        run: |
          echo "### Failure Condition Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SHOULD_FAIL=false
          FAILURE_REASONS=""

          # Get values from previous step
          DEFINITE_LEAKS="${{ steps.analyze.outputs.definite_leaks }}"
          TOTAL_ERRORS="${{ steps.analyze.outputs.total_errors }}"
          HAS_CRITICAL="${{ steps.analyze.outputs.has_critical_errors }}"
          INVALID_READ="${{ steps.analyze.outputs.invalid_read }}"
          INVALID_WRITE="${{ steps.analyze.outputs.invalid_write }}"
          INVALID_FREE="${{ steps.analyze.outputs.invalid_free }}"

          # Check 1: Critical memory errors (always fail)
          if [ "$HAS_CRITICAL" = "true" ]; then
            SHOULD_FAIL=true
            FAILURE_REASONS="$FAILURE_REASONS\n- ðŸ”´ Critical memory errors detected (Invalid Read/Write/Free)"
            echo "âŒ **CRITICAL:** Memory access errors detected" >> $GITHUB_STEP_SUMMARY
            echo "  - Invalid Reads: $INVALID_READ" >> $GITHUB_STEP_SUMMARY
            echo "  - Invalid Writes: $INVALID_WRITE" >> $GITHUB_STEP_SUMMARY
            echo "  - Invalid Frees: $INVALID_FREE" >> $GITHUB_STEP_SUMMARY
          fi

          # Check 2: Definite memory leaks (configurable)
          if [ "${{ env.FAIL_ON_LEAKS }}" = "true" ]; then
            if [ "$DEFINITE_LEAKS" -gt "${{ env.LEAK_THRESHOLD }}" ]; then
              SHOULD_FAIL=true
              FAILURE_REASONS="$FAILURE_REASONS\n- ðŸ”´ Definite leaks ($DEFINITE_LEAKS) exceed threshold (${{ env.LEAK_THRESHOLD }})"
              echo "âŒ **FAIL:** Definite leaks ($DEFINITE_LEAKS) exceed threshold (${{ env.LEAK_THRESHOLD }})" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Definite leaks ($DEFINITE_LEAKS) within threshold (${{ env.LEAK_THRESHOLD }})" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ Leak checking disabled via workflow input" >> $GITHUB_STEP_SUMMARY
          fi

          # Check 3: Total error threshold (configurable)
          if [ "$TOTAL_ERRORS" -gt "${{ env.ERROR_THRESHOLD }}" ]; then
            SHOULD_FAIL=true
            FAILURE_REASONS="$FAILURE_REASONS\n- ðŸŸ  Total errors ($TOTAL_ERRORS) exceed threshold (${{ env.ERROR_THRESHOLD }})"
            echo "âŒ **FAIL:** Total errors ($TOTAL_ERRORS) exceed threshold (${{ env.ERROR_THRESHOLD }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Total errors ($TOTAL_ERRORS) within threshold (${{ env.ERROR_THRESHOLD }})" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Final verdict
          if [ "$SHOULD_FAIL" = "true" ]; then
            echo "## âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Failure reasons:" >> $GITHUB_STEP_SUMMARY
            echo -e "$FAILURE_REASONS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Download the valgrind-reports artifact" >> $GITHUB_STEP_SUMMARY
            echo "2. Review memcheck.log for detailed stack traces" >> $GITHUB_STEP_SUMMARY
            echo "3. Fix memory issues before merging" >> $GITHUB_STEP_SUMMARY
            echo "4. Add suppressions to .valgrind/memcheck.supp for known false positives" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "## âœ… Build Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All memory checks passed within configured thresholds." >> $GITHUB_STEP_SUMMARY
          fi

  # Baseline comparison job (runs after memcheck on main branch)
  baseline-comparison:
    runs-on: ubuntu-latest
    needs: valgrind-memcheck
    if: github.ref == 'refs/heads/main' && needs.valgrind-memcheck.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download current report
        uses: actions/download-artifact@v4
        with:
          name: valgrind-reports
          path: valgrind-reports/

      - name: Save baseline metrics
        run: |
          echo "## Memory Baseline Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Definite Leaks | ${{ needs.valgrind-memcheck.outputs.definite_leaks }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Errors | ${{ needs.valgrind-memcheck.outputs.total_errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Date | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Baseline saved for future PR comparisons." >> $GITHUB_STEP_SUMMARY

      - name: Upload baseline
        uses: actions/upload-artifact@v4
        with:
          name: valgrind-baseline
          path: valgrind-reports/
          retention-days: 90

  # PR comparison job (compares PR against baseline)
  pr-comparison:
    runs-on: ubuntu-latest
    needs: valgrind-memcheck
    if: github.event_name == 'pull_request'

    steps:
      - name: Download PR report
        uses: actions/download-artifact@v4
        with:
          name: valgrind-reports
          path: pr-reports/

      - name: Compare with baseline
        run: |
          echo "## PR Memory Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | PR Value | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY

          PR_LEAKS="${{ needs.valgrind-memcheck.outputs.definite_leaks }}"
          PR_ERRORS="${{ needs.valgrind-memcheck.outputs.total_errors }}"

          if [ "$PR_LEAKS" -eq "0" ]; then
            echo "| Definite Leaks | $PR_LEAKS | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Definite Leaks | $PR_LEAKS | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$PR_ERRORS" -eq "0" ]; then
            echo "| Total Errors | $PR_ERRORS | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Total Errors | $PR_ERRORS | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Baseline comparison requires historical data from main branch runs." >> $GITHUB_STEP_SUMMARY
