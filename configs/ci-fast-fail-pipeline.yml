# Fast-Fail CI/CD Pipeline Configuration
#
# RDB-002 Testing Infrastructure Modernization
# Week 1: Implement fast-fail gate (<2min for lint/type/critical tests)
#
# Strategy: Run quick validation checks first, abort immediately on failure.
# Expected: 80% of failures caught in <2min, avoiding 18min full suite run.
#
# Usage: .github/workflows/fast-fail-pipeline.yml

name: Fast-Fail Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

# Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # STAGE 1: Fast-Fail Gate (<2min)
  # ============================================================================
  fast-fail-gate:
    name: Fast-Fail Gate (<2min)
    runs-on: ubuntu-latest
    timeout-minutes: 2  # Hard 2-minute timeout

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git diff

      - name: Setup Node.js (TypeScript)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python (Ada tooling)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies (cached)
        run: |
          npm ci --prefer-offline --no-audit
          pip install --no-deps -r requirements-lint.txt

      # ------------------------------------------------------------------------
      # Step 1: Linting (<30s expected)
      # ------------------------------------------------------------------------
      - name: "ðŸ” Lint: ESLint (TypeScript/JavaScript)"
        run: |
          echo "::group::ESLint"
          npm run lint -- --max-warnings 0
          echo "::endgroup::"
        timeout-minutes: 1

      - name: "ðŸ” Lint: Pylint (Python)"
        run: |
          echo "::group::Pylint"
          pylint src/ --fail-under=8.0
          echo "::endgroup::"
        timeout-minutes: 1

      - name: "ðŸ” Lint: GNAT Check (Ada)"
        run: |
          echo "::group::GNAT Check"
          gnatcheck -Ptests.gpr -rules -from=gnatcheck.rules
          echo "::endgroup::"
        timeout-minutes: 1

      # ------------------------------------------------------------------------
      # Step 2: Type Checking (<30s expected)
      # ------------------------------------------------------------------------
      - name: "ðŸ” Type Check: TypeScript"
        run: |
          echo "::group::TypeScript Type Check"
          npm run type-check
          echo "::endgroup::"
        timeout-minutes: 1

      # ------------------------------------------------------------------------
      # Step 3: Secret Scanning (<10s expected) - SECURITY BLOCKING
      # ------------------------------------------------------------------------
      - name: "ðŸ”’ Secret Scan: TruffleHog"
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified --fail
        timeout-minutes: 1

      - name: "ðŸ”’ Secret Scan: GitLeaks"
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        timeout-minutes: 1

      # ------------------------------------------------------------------------
      # Step 4: Critical Unit Tests (<1min expected)
      # ------------------------------------------------------------------------
      - name: "âœ… Critical Unit Tests: Payment, Auth, Security"
        run: |
          echo "::group::Critical Unit Tests"
          npm test -- --testPathPattern="(payment|auth|security)" --maxWorkers=4 --bail
          echo "::endgroup::"
        timeout-minutes: 1

      # ------------------------------------------------------------------------
      # Fast-Fail Summary
      # ------------------------------------------------------------------------
      - name: "âœ… Fast-Fail Gate: PASSED (<2min)"
        run: |
          echo "âœ… Fast-fail gate completed successfully!"
          echo "Total time: $(date -u -d @$SECONDS +%M:%S)"

  # ============================================================================
  # STAGE 2: Full Test Suite (Only if Stage 1 passes)
  # ============================================================================
  full-test-suite:
    name: Full Test Suite (Unit + Integration + Contract)
    runs-on: ubuntu-latest
    needs: fast-fail-gate  # Only runs if fast-fail-gate passes
    timeout-minutes: 5      # Target: <5min (down from 18min)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: "ðŸ§ª Unit Tests (50% of suite, <2min)"
        run: npm run test:unit -- --coverage --maxWorkers=8
        timeout-minutes: 2

      - name: "ðŸ¤ Contract Tests (30% of suite, <1min)"
        run: npm run test:contract
        timeout-minutes: 1

      - name: "ðŸ”— Integration Tests (15% of suite, <90s)"
        run: npm run test:integration
        timeout-minutes: 2

      - name: "ðŸŒ E2E Tests (5% of suite, <1min)"
        run: npm run test:e2e
        timeout-minutes: 1

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: true

  # ============================================================================
  # STAGE 3: Mutation Testing (Nightly only, not per-PR)
  # ============================================================================
  mutation-testing:
    name: Mutation Testing (Changed Files Only)
    runs-on: ubuntu-latest
    needs: full-test-suite
    if: github.event_name == 'pull_request'  # Only on PRs, not main branch
    timeout-minutes: 3  # Target: <2min for typical PR (10-20 files)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: "ðŸ§¬ Mutation Testing: Changed Files Only"
        run: |
          # Get changed TypeScript files
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep -E '\.(ts|js)$' | tr '\n' ',' || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No TypeScript/JavaScript files changed, skipping mutation testing"
            exit 0
          fi

          echo "Running mutation testing on: $CHANGED_FILES"
          npx stryker run --mutate "$CHANGED_FILES"
        timeout-minutes: 3

      - name: Upload mutation report
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: reports/mutation/
          retention-days: 7

  # ============================================================================
  # STAGE 4: Performance Benchmarking (Only on main branch)
  # ============================================================================
  performance-benchmarking:
    name: Performance Benchmarking (k6)
    runs-on: ubuntu-latest
    needs: full-test-suite
    if: github.ref == 'refs/heads/main'  # Only on main branch
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/v0.48.0/k6-v0.48.0-linux-amd64.tar.gz | tar xvz
          sudo mv k6-*/k6 /usr/local/bin/

      - name: "âš¡ Performance Tests: P95/P99 Regression Check"
        run: |
          k6 run tests/performance/baseline.js \
            --out json=reports/k6-results.json \
            --threshold http_req_duration{service:widget-core}=p(95)<500 \
            --threshold http_req_duration{service:widget-core}=p(99)<1000
        timeout-minutes: 3

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: reports/k6-results.json
          retention-days: 30

# ============================================================================
# Expected Execution Times
# ============================================================================
# Stage 1 (Fast-Fail): <2min
#   - Lint: 30s
#   - Type Check: 30s
#   - Secret Scan: 10s
#   - Critical Unit Tests: 1min
#
# Stage 2 (Full Suite): <5min
#   - Unit: 2min
#   - Contract: 1min
#   - Integration: 90s
#   - E2E: 1min
#
# Stage 3 (Mutation): <3min (changed files only)
# Stage 4 (Performance): <3min
#
# Total: <13min (down from 18min)
# Expected fast failure: 80% of PRs fail in <2min (Stage 1)
#
# Week 3 Validation: Monitor actual execution times, adjust thresholds
# Monitor: Grafana dashboard tracks pipeline duration trends
